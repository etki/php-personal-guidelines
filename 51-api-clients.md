# Клиенты API внешних сервисов

Все API-клиенты должны иметь как минимум двухуровневую систему: транспортный
уровень и уровень API, на котором методы API отображены в виде реальных методов
класса клиента. В большинстве случаев потребуется реализация третьего уровня -
уровня приложения, в котором операции API представлены в виде более понятных
приложению методов (например, операции "создать пользователя" и
"обновить пользователя" могут быть объединены в одну операция, которая выполнит
поиск по email пользователя, и, в случае обнаружения отсутствия пользователя,
создаст его).

Клиент API должен предоставлять разумный подход к инициализации клиента
(передача URL и данных подключения в конструкторе любого уровня) и подмене
классов различных уровней (для удобства тестирования и уменьшения связности).

Клиенты API реализуются в виде отдельных репозиториев и полностью независимы от
приложения.

## Транспортный уровень

Реализуется с помощью библиотек [guzzle/guzzle][] и [symfony/http-foundation][].
Guzzle необходим для простоты конфигурации и тестирования (см.
[guzzle mock plugin][]), в то время как библиотека Http Foundation нужна для
стандартизации передачи готовых запросов и ответов c Guzzle. Также транспортный
уровень должен предоставлять возможность внедрения слушателей запросов и
фильтров запросов перед передачей их слушателям - это позволит приложению вести
лог запросов, и в то же время с помощью фильтров исключать из запроса данные,
которые по тем или иным причинам должны быть исключены из лога (например, данные
пластиковой карты). В случае стандартизации реализуемого API обмен с вышележащим
уровнем осуществляется посредством объектов ApiRequest и ApiResponse, которые
также могут логироваться и фильтроваться без лишних данных.

## Уровень API

Просто зеркалит необходимые методы API с теми же параметрами. 

## Уровень приложения

Предоставляет удобный для приложения интерфейс, проксируя методы нижележащего
уровня, в то же время предоставляя методы для установления слушателей и
фильтров на нижележащих уровнях.

## Сущности

API, как правило, так или иначе имеют внутренние сущности (сим-карта,
пользователь, адрес). Такие сущности должны быть реализованы в виде отдельных
классов-структур, занимающихся исключительно передачей этих данных (сеттеры,
геттеры, проверка установленных данных) и передаваться приложением в верхний
уровень клиента там, где это необходимо.

# Тестирование клиентов API

Производится с помощью моков: каждый уровень тестируется отдельно, при этом
соседние уровни эмулируется (в случае с транспортным уровнем используется
[guzzle mock plugin][]), после этого все уровни тестируются вместе (опять с
использованием [guzzle mock plugin][]), после чего тестируются идемпотентные
методы **на присутствие в возвращаемом ответе ожидаемой структуры данных**.
Проверка реально возвращаемых данных, как правило, бесполезна, т.к. эти данные
могут меняться.

  [guzzle/guzzle]: https://packagist.org/packages/guzzle/guzzle
  [symfony/http-foundation]: https://packagist.org/packages/symfony/http-foundation
  [guzzle mock plugin]: https://packagist.org/packages/guzzle/plugin-mock
