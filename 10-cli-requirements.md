# Требования к консольным командам

## Команды жизненного цикла

Приложение обязательно должно обязательно выполнять следующую цепочку
команд:

* `validate`
* `clean`
* `install`
* `build`

В отличие от проектов, построенных с помощью сборщиков, для выполнения
этих команд требуется предварительно выполнить
`composer install --no-dev`. Команды последовательно зависят друг от
друга, т.е. команда `validate` выполнится в одиночку, а `install`
предварительно вызовет `validate` и `clean`, при этом подключение к базе
данных проверяться не будет.

### validate

Проверяет приложение на наличие ошибок: присутствие необходимых
ресурсов, наличие ключей конфигурации, подключение к БД.

### clean

Очищает директорию приложения от сгенерированных файлов, будь то
сгенерированный код, временные или `.lock`-файлы.

### install

Устанавливает приложение, скачивая и копирую необходимые ресурсы,
применяя миграции и генерируя необходимый код.

### build

Упаковывает установленное приложение в zip-архив, удаляя машинозависимую
конфигурацию (подключение к БД, данные для подключения к API).

## Дополнительные обязательные команды

### app:info

Выводит базовую информацию о приложении:

* Имя
* Версия
* Текущее окружение
* Текущие настройки подключения к базам данных севреам кэша, серверам очередей
* Текущие настройки подключения к внешним API

## Обязательные флаги и опции консольных команд

### --env={env}

Принудительное задание окружения.

### --dry-run

Идемпотентное выполнение команды с описание неидемпотентных действий вместо их
произведения.

# Написание произвольных команд

Любая команда сначала реализовывается в виде *задачи*, интерфейс которой
может быть произвольным, но единым для всего проекта. Такая задача не
привязана сама по себе ни к консольной команде, ни к консольному выводу:
о существовании консольных команд она не догадывается (консольная
команда сама решает, какие задачи она будет вызывать), весь вывод
осуществляется с помощью произвольного контроллера I/O. Такой подход
позволяет выделить функционал одной конкретной задачи, делать вложенные
задачи, гибко управлять выводом (фильтровать, изменять индентацию и пр.)
и полностью отвязать реализацию от самих команд, что позволяет
дублировать один и тот же функционал без значимых затрат.

## Рекомендованные дополнительные команды

### app:status

Выводит информацию о текущем состоянии приложения: среднее время ответа,
предупреждения, аптайм, наличие упавших компонентов и прочее. Содержимое вывода
зависит только от функционала приложения.

### app:check

Проверяет работоспособность приложения. Сюда входит проверка подключений к БД,
кэшам серверов, использование идемпотентных методов API для проверки их
работоспособности. По-большому счету, это smoke-тесты без непосредственно
тестирования кода.

### app:api:{api-client}:ping

Выполняет проверку работоспособности API-клиента.

### app:update

Пробует скачать и применить обновления: выполнить `git pull`, применить
миграции, применить специфичные обновления.
